---
layout: post
title: "R语言中的面向对象编程风格（一）:S3"
date:   2018-11-22 21:30:00 +0800
categories: 学习总结
tag: R语言
---

* content
{:toc}



<img src="{{ '/posts/study.jpg' | prepend: site.baseurl }}" alt="学习" width="310" />

前言   
====================================
在查看R语言各类函数的帮助文档时，在`usage`条目下，我们常常能够看到这样的表述：`Default S3 method`，那么这个S3 method到底是什么呢？
首先回顾一下面向对象是什么：
>任何面向对象系统的核心都是类和方法的概念。 通过描述类的属性以及它与其它类的关系，类定义了对象的行为。 类也用于选择方法，函数会根据输入的不同的类，表现出不同的行为。类通常被组织成层次结构：如果某个子类的方法不存在，那么将使用父类的方法。 子类从父类那里继承行为。

简单的说，S3是R语言中的一种面向对象编程风格，而R语言中一共有三种面向对象风格，即`S3,S4和RC`，这篇主要对S3做一个小小的总结。

前提条件   
====================================
以下测试需要预先安装`pryr`包

S3   
====================================
+ S3是R语言中的第一种和最简单的面向对象系统。
+ S3实现了一种被称为泛型函数面向对象的面向对象编程风格。它仍然通过方法来进行计算，但是由一种称为泛型函数的特殊类型函数来决定调用哪个方法。
+ 这是base包和stats包中唯一使用的面向对象系统，也是CRAN网站上发布的包中最常用的系统。 
+ S3并不正式，但它非常的优雅和简洁。

泛型函数
------------------------------------
看到这个名字时，我首先想到了之前去年学的泛函分析：泛函--函数的函数。在R语言中，泛型函数意义有所不同，但也可以和之前学过的泛函做一个比照。在S3中，方法属于函数，称为
泛型函数(generic functions)，或简称为泛型(generics)。 S3的方法不属于对象或类。 这不同于大多数其它编程语言，但是这是一种有效的面向对象风格。给定一个类，S3泛型函数的
工作是调用正确的S3方法。 可以通过名字来认识S3方法，它们看起来像generic.class()。 例如，Date类的`mean()`泛型函数是`mean.Date()`，而factor类的`print()`泛型函数是`print.factor()`。
**注意**：大多数的现代编程风格指南，都不鼓励把.用在函数名中：因为这让它们看起来像S3的方法。 例如，`t.test()`是t对象的`test()`方法吗？

可以使用`ftype()`函数查看函数是S3方法还是泛函:
```
ftype(t.data.frame) # 数据框的t()方法 
#> [1] "s3" "method" 
ftype(t.test) # t检验的泛型函数 
#> [1] "s3" "generic"
```

可以使用methods()查看所有属于某个泛型函数的方法： 
```
methods("mean") 
#> [1] mean.Date mean.default mean.difftime mean.POSIXct 
#> [5] mean.POSIXlt methods("t.test") 
#> [1] t.test.default* t.test.formula* 
#> 
#> Non-visible functions are asterisked
```


创建新方法和泛型函数
------------------------------------
要添加一个新的泛型函数，可以创建一个函数，然后调用UseMethod()。 UseMethod()有两个参数：泛型函数的名称，以及用于方法分派的参数。
```
f <- function(x) {
UseMethod("f")
}
```
如果没有一些具体的方法，那么泛型函数是没用的。 要添加一个方法，你只需使用正确的名称(generic.class)创建一个普通函数：
```
f.a <- function(x) "Class a" 
a <- structure(list(), class = "a") 
class(a) 
#> [1] "a" 
f(a) 
#> [1] "Class a"
```

方法分派
------------------------------------
S3的方法分派(Method dispatch)相对简单。 `UseMethod()`创建一个包含函数名的向量，比如`paste0("generic", ".", c(class(x), "default"))`，
然后依次寻找每一个函数。 "default"类使得为未知的类，设置一个默认方法提供了可能。

小结（S3的不足）
------------------------------------
+ S3对象并不是完全的面向对象实现，而是一种通过泛型函数模拟的面向对象的实现。
+ S3使用起来简单，但在实际的面向对象编程过程中，当对象关系有一定的复杂度，S3对象所表达的意义就会变得不太清楚。
+ S3封装的内部函数，可绕过泛型函数的检查，以直接被调用。
+ S3参数的class属性，可以被任意设置，没有预处理的检查。
+ S3参数，只能通过调用class属性进行函数调用，其他属性则不会被class()函数执行。
+ S3参数的class属性有多个值时，调用时会按照程序赋值顺序来调用第一个合法的函数。而S4可以对泛型函数进行`基于多个参数的方法分派`

reference   
====================================
+  Advanced R 第七章（Hadley Wickham） 第七章 [附一个中文版](http://yukawax.cn/posts/Advanced_R.pdf)
+ [R语言基于S3的面向对象编程](http://blog.fens.me/r-class-s3/)